sudo apt install python3-pip
pip3 install cherrypy
pip3 install lupa
pip3 install numpy
pip3 install google-auth-httplib2
pip3 install azure-storage
export SHKOLA_IP_ADDR=10.0.0.4





# Not needed: export SHKOLA_IP_ADDR=`curl --silent -H Metadata:true "http://169.254.169.254/metadata/instance/network/interface/0/ipv4/ipAddress/0/publicIpAddress?api-version=2017-04-02&format=text"`


# How to install functions:
# https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local#v2
# https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-function-python

# Reference design for serverless web app: https://docs.microsoft.com/en-us/azure/architecture/reference-architectures/serverless/web-app



* Start python virtual env:

  python3 -m venv .venv
  source .venv/bin/activate


* Exit virtual env:
  deactivate


* Install requirements in virtual environment
  pip3 install -r requirements.txt

* Start local hosting:
  func host start


* Deploy on Azure:
az functionapp create --resource-group Shkola --os-type Linux --consumption-plan-location westeurope  --runtime python --runtime-version 3.7 --name Shkola --storage-account shkola
func azure functionapp publish shkola --build remote


# For external BLOB access, add your IP to the storage whitelist




# Docker config
Q: How to set up credentials?
https://github.com/docker/docker-credential-helpers/issues/102




# Docker deployment:

NOTE: All environment variables go into Dockerfile

~/Documents/Code/shkola$ docker rm -f shkola 
~/Documents/Code/shkola$ docker build -f src/Dockerfile --tag bradunov/shkola:v0.0.1 .


- To run with local SQL results
~/Documents/Code/shkola$ docker run -p 8080:80 --name shkola -it bradunov/shkola:v0.0.1

NOTE: This doesn't seem to work on WSL!:
~/Documents/Code/shkola$ docker run -p 8080:80 --name shkola -v /c/Users/bozidar/Documents/Code/shkola/sql:/var/log/sql -e SHKOLA_SQL_PATH="/var/log/sql" -it bradunov/shkola:v0.0.1
(if running on WSL, enable drive sharing on docker for windows)

- To run with Azure table for results
~/Documents/Code/shkola$ docker run -p 8080:80 --name shkola -e SHKOLA_AZ_TABLE_CONN_STR="<connection_str>" -it bradunov/shkola:v0.0.1


Web site: http://127.0.0.1:8080/main





# Debug:

~/Documents/Code/shkola$ docker exec -it shkola bash
root@c05eacf46021:/# ls /home/site/wwwroot/




az group create --name testdoc --location westeurope
az storage account create --name testdocshkola --location westeurope --resource-group testdoc --sku Standard_LRS
az functionapp plan create --resource-group testdoc --name myTestPlan --location westeurope --number-of-workers 1 --sku CP1 --is-linux
az functionapp create --name testshkoladocker --storage-account testdocshkola --resource-group testdoc --plan myTestPlan --deployment-container-image-name bradunov/shkola:v0.0.1



# Continuous deployment:
https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-function-linux-custom-image?tabs=nodejs#enable-continuous-deployment

az functionapp deployment container config --enable-cd --query CI_CD_URL --output tsv --name testshkoladocker --resource-group testdoc





#### LOGGING:

Do not print with print(), use logging.<level>
Q: How to change the default log message to add SHKOLA in it for searchable logs?



